# Configuraci√≥n MQTT para WLED (URLs Cortas)

## Problema con HiveMQ Cloud

Los clusters personales de HiveMQ tienen URLs muy largas que **superan el l√≠mite de caracteres** de WLED:

```
‚ùå 90717923c01b4a4da3718559007344ac.s1.eu.hivemq.cloud (50+ caracteres)
```

## Soluci√≥n: Brokers P√∫blicos con URLs Cortas

Usa estos brokers MQTT p√∫blicos que **S√ç caben** en WLED:

---

### Opci√≥n 1: Eclipse Mosquitto (RECOMENDADO)

**Broker:** `test.mosquitto.org`
**Puerto:** `1883` (sin SSL) o `8883` (con SSL)
**Usuario:** *(vac√≠o)*
**Contrase√±a:** *(vac√≠o)*

‚úÖ **Pros:**
- URL corta (19 caracteres)
- Muy estable
- Comunidad grande
- Gratuito siempre

‚ö†Ô∏è **Contras:**
- P√∫blico (sin autenticaci√≥n)
- Usa un topic √∫nico para tu seguridad

---

### Opci√≥n 2: HiveMQ Public Broker

**Broker:** `broker.hivemq.com`
**Puerto:** `1883`
**Usuario:** *(vac√≠o)*
**Contrase√±a:** *(vac√≠o)*

‚úÖ **Pros:**
- URL muy corta (17 caracteres)
- Infraestructura de HiveMQ
- Muy r√°pido
- Gratuito

‚ö†Ô∏è **Contras:**
- P√∫blico (sin autenticaci√≥n)
- Usa un topic √∫nico

---

### Opci√≥n 3: Eclipse IoT

**Broker:** `mqtt.eclipseprojects.io`
**Puerto:** `1883` o `8883`
**Usuario:** *(vac√≠o)*
**Contrase√±a:** *(vac√≠o)*

‚úÖ **Pros:**
- Proyecto Eclipse oficial
- Estable

‚ö†Ô∏è **Contras:**
- URL un poco m√°s larga (24 caracteres)
- P√∫blico (sin autenticaci√≥n)

---

## Configuraci√≥n en WLED (Paso a Paso)

### Paso 1: Acceder a WLED

1. Conecta tu ordenador/m√≥vil a la misma red WiFi que el ESP
2. Abre navegador y ve a: `http://192.168.1.100` (o la IP de tu ESP)
3. Si no sabes la IP:
   - Busca en la lista de dispositivos de tu router
   - O usa app "WLED" desde m√≥vil (detecta autom√°ticamente)

### Paso 2: Configurar MQTT

1. En WLED, click en **"Config"** (icono de engranaje)
2. Click en **"Sync Interfaces"**
3. Baja hasta la secci√≥n **"MQTT"**

### Paso 3: Configurar Broker

Introduce estos datos (usa uno de los brokers de arriba):

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Enable MQTT              [‚úì]                ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Broker:                                     ‚îÇ
‚îÇ [test.mosquitto.org________________]       ‚îÇ ‚Üê Broker (elige uno)
‚îÇ                                             ‚îÇ
‚îÇ Port:                                       ‚îÇ
‚îÇ [1883___]                                   ‚îÇ ‚Üê Puerto
‚îÇ                                             ‚îÇ
‚îÇ Username:                                   ‚îÇ
‚îÇ [__________________________________]        ‚îÇ ‚Üê Dejar VAC√çO
‚îÇ                                             ‚îÇ
‚îÇ Password:                                   ‚îÇ
‚îÇ [__________________________________]        ‚îÇ ‚Üê Dejar VAC√çO
‚îÇ                                             ‚îÇ
‚îÇ Client ID:                                  ‚îÇ
‚îÇ [wled_tree_antonio_12345___________]       ‚îÇ ‚Üê ID √∫nico
‚îÇ                                             ‚îÇ
‚îÇ Device Topic:                               ‚îÇ
‚îÇ [wled/antonio/tree1________________]       ‚îÇ ‚Üê Topic √∫nico
‚îÇ                                             ‚îÇ
‚îÇ Group Topic:                                ‚îÇ
‚îÇ [wled/antonio/all__________________]       ‚îÇ ‚Üê Topic de grupo
‚îÇ                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Paso 4: Valores Espec√≠ficos

**Para seguridad, usa topics √öNICOS**. Aqu√≠ tienes ejemplos:

#### Client ID (debe ser √∫nico):
```
wled_tree_antonio_12345
wled_navidad_casa_789
wled_arbol_living_abc
```
**Tip:** A√±ade n√∫meros aleatorios al final

#### Device Topic (para comandos individuales):
```
wled/antonio/tree1
wled/tuhombre/arbol
wled/casa123/navidad
```

#### Group Topic (para comandos a varios dispositivos):
```
wled/antonio/all
wled/tuhombre/all
wled/casa123/all
```

**IMPORTANTE:** Usa tu nombre o identificador √∫nico en lugar de "antonio" para evitar conflictos con otros usuarios.

### Paso 5: Guardar y Reiniciar

1. Click en **"Save"** al final de la p√°gina
2. WLED se reiniciar√° autom√°ticamente
3. Espera 10-20 segundos

### Paso 6: Verificar Conexi√≥n

1. Vuelve a entrar a WLED
2. Ve a **Info**
3. Busca la secci√≥n **MQTT**
4. Deber√≠a decir: **"Connected"** o **"Conectado"**

Si dice **"Disconnected"** o **"Error"**:
- Verifica que el ESP tenga acceso a internet
- Verifica que el broker est√© escrito correctamente
- Revisa la secci√≥n "Soluci√≥n de Problemas" m√°s abajo

---

## Configuraci√≥n en la Aplicaci√≥n Web

### Opci√≥n A: Usar el broker p√∫blico configurado

Abre `index.html` y busca esta secci√≥n (l√≠nea ~593):

```javascript
function initMQTT() {
    console.log('üîå Iniciando conexi√≥n MQTT...');

    let broker, username, password;

    if (connectionMode === 'mqtt-public') {
        // Mosquitto test broker
        broker = 'wss://test.mosquitto.org:8081/mqtt';  // ‚Üê WebSocket
        username = '';
        password = '';
    }
```

**IMPORTANTE:** La web usa **WebSocket** (puerto 8081) mientras WLED usa **TCP** (puerto 1883). Ambos se conectan al mismo broker.

### Opci√≥n B: Configurar manualmente en la web

1. Abre `index.html` en tu navegador
2. Selecciona modo **"MQTT P√∫blico"**
3. ¬°Ya deber√≠a funcionar!

---

## Topics MQTT - C√≥mo Funciona

WLED usa estos topics:

### Para enviar comandos (Web ‚Üí WLED):
```
wled/antonio/tree1/api
```

Publica comandos JSON como:
```json
{"on": true, "bri": 128, "seg": [{"col": [[255,0,0]]}]}
```

### Para recibir estado (WLED ‚Üí Web):
```
wled/antonio/tree1/v
wled/antonio/tree1/status
```

**La aplicaci√≥n web ya maneja todo esto autom√°ticamente.**

---

## Seguridad con Brokers P√∫blicos

Los brokers p√∫blicos **no tienen autenticaci√≥n**, pero puedes protegerte:

### 1. Usa Topics √önicos y Dif√≠ciles de Adivinar

‚ùå **Malo:**
```
wled/tree
wled/lights
wled/esp
```

‚úÖ **Bueno:**
```
wled/antonio_xk7p92/tree1
wled/miCasa_2024_abc/navidad
wled/secreto_8x9z/arbol
```

### 2. No pongas informaci√≥n sensible

Los brokers p√∫blicos pueden ser le√≠dos por cualquiera. Solo √∫salos para:
- ‚úÖ Controlar luces
- ‚úÖ Proyectos no cr√≠ticos
- ‚ùå Datos personales
- ‚ùå Controles de seguridad (cerraduras, alarmas)

### 3. Cambia el topic peri√≥dicamente

Si sospechas que alguien descubri√≥ tu topic, c√°mbialo en WLED.

---

## Soluci√≥n de Problemas

### WLED no se conecta al broker

**S√≠ntomas:** En WLED ‚Üí Info ‚Üí MQTT dice "Disconnected"

**Soluciones:**

1. **Verifica acceso a internet del ESP:**
   ```
   - Abre WLED ‚Üí Info
   - Busca "Gateway" y "DNS"
   - Deber√≠an tener IPs v√°lidas (ej: 192.168.1.1, 8.8.8.8)
   ```

2. **Verifica el broker:**
   ```
   - Debe ser exactamente: test.mosquitto.org
   - Sin espacios antes/despu√©s
   - Sin https:// ni / al final
   - Min√∫sculas
   ```

3. **Verifica el puerto:**
   ```
   - Debe ser: 1883
   - No 8883 (a menos que uses SSL)
   - No 8081 (ese es para WebSocket)
   ```

4. **Prueba otro broker:**
   - Cambia a `broker.hivemq.com`
   - A veces un broker est√° ca√≠do

5. **Verifica firewall del router:**
   - Algunos routers bloquean puerto 1883
   - Llama a tu ISP si es necesario

---

### La web no se conecta

**S√≠ntomas:** En la web dice "Error MQTT" o "Desconectado"

**Soluciones:**

1. **Verifica que uses el puerto WebSocket:**
   ```javascript
   // CORRECTO:
   broker = 'wss://test.mosquitto.org:8081/mqtt';

   // INCORRECTO:
   broker = 'test.mosquitto.org';  // Falta wss:// y puerto
   ```

2. **Abre la consola del navegador:**
   - Presiona F12
   - Ve a pesta√±a "Console"
   - Busca errores MQTT
   - Comp√°rtelos si necesitas ayuda

3. **Verifica CORS:**
   - Algunos navegadores bloquean WebSocket
   - Prueba con Chrome o Firefox

---

### WLED conecta pero no recibe comandos

**S√≠ntomas:** WLED dice "Connected" pero no cambia al dar √≥rdenes desde la web

**Soluciones:**

1. **Verifica que los topics coincidan:**

   **En WLED:**
   ```
   Device Topic: wled/antonio/tree1
   ```

   **En index.html (l√≠nea ~542):**
   ```javascript
   mqttClient.publish('wled/antonio/tree1/api', payloadStr);
   ```

   ¬°Deben ser **exactamente iguales**!

2. **Verifica el formato del comando:**

   WLED espera JSON v√°lido:
   ```json
   {"on":true,"bri":128}
   ```

   Abre consola del navegador y verifica que se env√≠e correctamente.

3. **Prueba con MQTT Explorer:**

   Descarga [MQTT Explorer](http://mqtt-explorer.com/) y con√©ctate al broker:
   - Host: `test.mosquitto.org`
   - Port: `1883`
   - Publica manualmente en `wled/antonio/tree1/api`
   - Si funciona, el problema est√° en la web

---

### Latencia alta o comandos lentos

**S√≠ntomas:** Los comandos tardan >5 segundos

**Soluciones:**

1. **Verifica conexi√≥n a internet del ESP:**
   - WiFi d√©bil = latencia alta
   - Acerca el ESP al router
   - O usa repetidor WiFi

2. **Cambia de broker:**
   ```
   test.mosquitto.org  ‚Üí Servidores en UK
   broker.hivemq.com   ‚Üí Servidores globales (m√°s r√°pido)
   ```

3. **Verifica QoS:**
   - En el c√≥digo, usa QoS 0 (m√°s r√°pido) en lugar de QoS 1
   - L√≠nea en index.html:
   ```javascript
   mqttClient.publish('wled/tree/api', payloadStr, { qos: 0 });
   ```

---

## Comparaci√≥n de Brokers P√∫blicos

| Broker | URL | Longitud | Puerto TCP | Puerto WS | Estabilidad |
|--------|-----|----------|------------|-----------|-------------|
| **Mosquitto** | test.mosquitto.org | 19 chars | 1883 | 8081 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **HiveMQ Public** | broker.hivemq.com | 17 chars | 1883 | 8000 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| **Eclipse IoT** | mqtt.eclipseprojects.io | 24 chars | 1883 | 443 | ‚≠ê‚≠ê‚≠ê‚≠ê |

**Recomendaci√≥n:** Usa **test.mosquitto.org** - Es el m√°s usado y documentado.

---

## Configuraci√≥n de Topics en index.html

Si cambiaste los topics en WLED, debes cambiarlos tambi√©n en la web.

Busca en `index.html` (l√≠neas ~540-545):

```javascript
async function sendViaMQTT(payload) {
    const payloadStr = JSON.stringify(payload);
    console.log('üì§ MQTT ‚Üí Enviando:', payloadStr.substring(0, 100));

    try {
        // CAMBIA ESTO si usas topics diferentes:
        mqttClient.publish('wled/antonio/tree1/api', payloadStr, { qos: 1, retain: false });
        //                  ^^^^^^^^^^^^^^^^^^^^^^
        //                  Debe coincidir con "Device Topic" en WLED + "/api"
```

**Formato:**
```
[Device Topic en WLED] + "/api"

Ejemplos:
wled/antonio/tree1  ‚Üí wled/antonio/tree1/api
wled/casa/navidad   ‚Üí wled/casa/navidad/api
wled/usuario/luces  ‚Üí wled/usuario/luces/api
```

---

## Alternativa: Usar IP del Broker (Avanzado)

Si el broker p√∫blico tiene un dominio largo pero una IP corta, puedes usar la IP directamente:

### Encontrar IP del broker:

```bash
# Windows
nslookup test.mosquitto.org

# Linux/Mac
dig test.mosquitto.org

# Resultado ejemplo:
# test.mosquitto.org ‚Üí 91.121.93.94
```

### Usar IP en WLED:

```
Broker: 91.121.93.94
Port: 1883
```

‚ö†Ô∏è **Advertencia:** Las IPs de los brokers pueden cambiar. Solo usa esto si es necesario.

---

## Resumen de Configuraci√≥n R√°pida

### En WLED:
```
Broker:        test.mosquitto.org
Port:          1883
Username:      (vac√≠o)
Password:      (vac√≠o)
Client ID:     wled_miNombre_123
Device Topic:  wled/miNombre/tree1
Group Topic:   wled/miNombre/all
```

### En la Web:
```javascript
// index.html (l√≠nea ~593)
broker = 'wss://test.mosquitto.org:8081/mqtt';

// index.html (l√≠nea ~542)
mqttClient.publish('wled/miNombre/tree1/api', ...);
```

### Verificaci√≥n:
1. WLED ‚Üí Info ‚Üí MQTT ‚Üí Deber√≠a decir "Connected"
2. Web ‚Üí Selecciona "MQTT P√∫blico"
3. Cambia un color
4. ¬°Deber√≠a funcionar!

---

## Pr√≥ximos Pasos

1. ‚úÖ Elige un broker (recomiendo `test.mosquitto.org`)
2. ‚úÖ Config√∫ralo en WLED (5 minutos)
3. ‚úÖ Verifica que WLED diga "Connected"
4. ‚úÖ Actualiza topics en `index.html` si es necesario
5. ‚úÖ Abre la web y selecciona "MQTT P√∫blico"
6. ‚úÖ ¬°Controla tus luces desde cualquier lugar!

---

## ¬øNecesitas Ayuda?

Si tienes problemas:

1. Verifica cada paso sistem√°ticamente
2. Abre consola del navegador (F12) y busca errores
3. Verifica en WLED ‚Üí Info que diga "MQTT: Connected"
4. Comparte los errores espec√≠ficos que veas

---

**¬øListo?** Configura WLED con `test.mosquitto.org` y pru√©balo. Es la soluci√≥n m√°s simple sin acceso al router. üöÄ
