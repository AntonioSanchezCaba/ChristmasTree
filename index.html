<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Christmas LED Tree - Mosquitto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            overflow: hidden;
            height: 100vh;
            color: #333;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .tree-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        .tree-container {
            position: relative;
            width: 90%;
            height: 90%;
            max-width: 800px;
            max-height: 900px;
        }
        
        #treeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #treeCanvas:active {
            cursor: grabbing;
        }
        
        .control-panel {
            width: 450px;
            background: rgba(255, 255, 255, 0.98);
            overflow-y: auto;
            box-shadow: -5px 0 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .panel-header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .panel-content {
            padding: 20px;
            flex-grow: 1;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .debug-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .debug-log div {
            margin: 2px 0;
            padding: 2px;
        }
        
        .debug-log .success {
            color: #28a745;
        }
        
        .debug-log .error {
            color: #dc3545;
        }
        
        .debug-log .info {
            color: #007bff;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        
        button.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        }
        
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        button.danger:hover {
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }
        
        .color-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background-color: transparent;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border: 3px solid #ddd;
            border-radius: 8px;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 5px;
        }
        
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 5px;
        }
        
        .brightness-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="main-container">
        <div class="tree-view">
            <div class="tree-container">
                <canvas id="treeCanvas"></canvas>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel-header">
                <h1>üéÑ Christmas LED Tree</h1>
                <p style="font-size: 0.9em; opacity: 0.9;">MQTT Mosquitto Controller</p>
            </div>
            
            <div class="panel-content">
                <!-- SECCI√ìN DE CONEXI√ìN MQTT -->
                <div class="section">
                    <div class="section-title">üîå Conexi√≥n MQTT</div>
                    
                    <div class="connection-status connecting" id="connectionStatus">
                        üîÑ Conectando...
                    </div>
                    
                    <div class="info-box">
                        <strong>üì° Servidor:</strong> mqtt.vittence.com<br>
                        <strong>üîì Protocolo:</strong> WebSocket (sin SSL) - Puerto 8080<br>
                        <strong>üéØ Topic:</strong> wled/tree/api<br>
                        <strong>‚ö†Ô∏è Compatible:</strong> WLED sin soporte TLS<br>
                        <strong>üí° Nota:</strong> Funciona desde HTTPS
                    </div>
                    
                    <button onclick="reconnectMQTT()">üîÑ Reconectar MQTT</button>
                    <button onclick="sendTestMessage()">üì§ Enviar Mensaje de Prueba</button>
                    <button onclick="resetWLED()" class="danger">üî¥ Apagar LEDs</button>
                    
                    <div class="debug-log" id="debugLog"></div>
                </div>
                
                <!-- SECCI√ìN DE CONTROL DE COLOR -->
                <div class="section">
                    <div class="section-title">üí° Control de Color</div>
                    <div class="color-selector">
                        <input type="color" id="ledColor" value="#ff0000" onchange="updateSelectedColor()">
                        <button onclick="activatePaintMode()" id="paintBtn">Activar Paint Mode</button>
                    </div>
                </div>
                
                <!-- SECCI√ìN DE BRILLO -->
                <div class="section">
                    <div class="section-title">üí° Brillo</div>
                    <div class="brightness-control">
                        <input type="range" id="brightness" min="0" max="255" value="128" oninput="updateBrightness()">
                        <span id="brightVal" style="min-width: 50px; font-weight: 600;">50%</span>
                    </div>
                </div>
                
                <!-- SECCI√ìN DE PRUEBAS DE COLOR -->
                <div class="section">
                    <div class="section-title">üß™ Pruebas de Color</div>
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                        Prueba cada color en todos los LEDs:
                    </p>
                    <button onclick="testColorDirect('red')" style="background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);">üî¥ Test ROJO</button>
                    <button onclick="testColorDirect('green')" style="background: linear-gradient(135deg, #44ff44 0%, #00cc00 100%);">üü¢ Test VERDE</button>
                    <button onclick="testColorDirect('blue')" style="background: linear-gradient(135deg, #4444ff 0%, #0000cc 100%);">üîµ Test AZUL</button>
                    <button onclick="testColorRGB()" style="background: linear-gradient(135deg, #ff0000 0%, #00ff00 50%, #0000ff 100%);">üåà Ciclo RGB</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Three.js desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- MQTT.js desde CDN -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <script>
        // =====================================================
        // VARIABLES GLOBALES
        // =====================================================
        
        let scene, camera, renderer, ledGroup;
        let ledMeshes = [];
        let selectedColor = '#ff0000';
        let paintMode = false;
        let currentBrightness = 128;
        
        // MQTT Configuration
        let mqttClient = null;
        const MQTT_CONFIG = {
            broker: 'wss://mqtt.vittence.com:8084/mqtt',,  // Puerto sin SSL (compatible con WLED)
            topic: 'wled/tree/api',
            username: '',
            password: ''
        };
        
        // Configuraci√≥n del √°rbol
        const totalLeds = 200;
        const COLOR_ORDER = 'GRB';
        
        // =====================================================
        // DEBUG LOG
        // =====================================================
        
        function addDebugLog(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Limitar a 50 mensajes
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }
        
        // =====================================================
        // CONEXI√ìN MQTT
        // =====================================================
        
        function initMQTT() {
            addDebugLog('üîå Iniciando conexi√≥n a Mosquitto...', 'info');
            addDebugLog(`üì° Broker: ${MQTT_CONFIG.broker}`, 'info');
            
            const options = {
                clientId: 'web-tree-' + Math.random().toString(16).substr(2, 8),
                clean: true,
                reconnectPeriod: 5000,
                connectTimeout: 30000,
                protocol: 'wss',
                protocolVersion: 4,
                rejectUnauthorized: true,
                keepalive: 60
            };
            
            // Solo agregar credenciales si existen
            if (MQTT_CONFIG.username) {
                options.username = MQTT_CONFIG.username;
                options.password = MQTT_CONFIG.password;
            }
            
            try {
                mqttClient = mqtt.connect(MQTT_CONFIG.broker, options);
                
                mqttClient.on('connect', () => {
                    addDebugLog('‚úÖ Conectado exitosamente a Mosquitto!', 'success');
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').textContent = '‚úÖ Conectado';
                    
                    // Suscribirse a topics de respuesta
                    mqttClient.subscribe('wled/tree/#', (err) => {
                        if (!err) {
                            addDebugLog('üì° Suscrito a topics WLED', 'success');
                        } else {
                            addDebugLog('‚ö†Ô∏è Error al suscribirse: ' + err.message, 'error');
                        }
                    });
                });
                
                mqttClient.on('error', (err) => {
                    addDebugLog('‚ùå Error MQTT: ' + err.message, 'error');
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = '‚ùå Error de conexi√≥n';
                    
                    // Sugerencias de troubleshooting
                    if (err.message.includes('ENOTFOUND') || err.message.includes('getaddrinfo')) {
                        addDebugLog('üí° Verifica que el DNS apunte correctamente', 'error');
                    } else if (err.message.includes('ECONNREFUSED') || err.message.includes('timeout')) {
                        addDebugLog('üí° Verifica que el puerto 8083 est√© abierto en el firewall', 'error');
                        addDebugLog('üí° Prueba cambiar 8083 por: 8084, 9001 en el c√≥digo', 'error');
                    }
                });
                
                mqttClient.on('reconnect', () => {
                    addDebugLog('üîÑ Intentando reconectar...', 'info');
                    document.getElementById('connectionStatus').className = 'connection-status connecting';
                    document.getElementById('connectionStatus').textContent = 'üîÑ Reconectando...';
                });
                
                mqttClient.on('offline', () => {
                    addDebugLog('‚ö†Ô∏è Cliente MQTT offline', 'error');
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                    document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è Desconectado';
                });
                
                mqttClient.on('message', (topic, message) => {
                    addDebugLog(`üì® Mensaje: ${topic} = ${message.toString().substring(0, 50)}...`, 'success');
                });
                
                // Debug adicional
                mqttClient.on('packetsend', (packet) => {
                    if (packet.cmd !== 'pingreq') {  // Ignorar pings
                        addDebugLog(`üì§ Enviando: ${packet.cmd}`, 'info');
                    }
                });
                
                mqttClient.on('packetreceive', (packet) => {
                    if (packet.cmd !== 'pingresp') {  // Ignorar pongs
                        addDebugLog(`üì• Recibido: ${packet.cmd}`, 'info');
                    }
                });
                
            } catch (error) {
                addDebugLog('‚ùå Error cr√≠tico al inicializar: ' + error.message, 'error');
            }
        }
        
        function reconnectMQTT() {
            if (mqttClient) {
                addDebugLog('üîÑ Desconectando cliente anterior...', 'info');
                mqttClient.end(true);
                mqttClient = null;
            }
            setTimeout(() => {
                initMQTT();
            }, 500);
        }
        
        // =====================================================
        // ENV√çO DE COMANDOS
        // =====================================================
        
        async function sendMQTTCommand(payload) {
            if (!mqttClient || !mqttClient.connected) {
                addDebugLog('‚ùå No hay conexi√≥n MQTT', 'error');
                showStatus('‚ùå No conectado a MQTT', true);
                return false;
            }
            
            const payloadStr = JSON.stringify(payload);
            addDebugLog(`üì§ Enviando comando: ${payloadStr.substring(0, 80)}...`, 'info');
            
            try {
                mqttClient.publish(MQTT_CONFIG.topic, payloadStr, { qos: 1, retain: false }, (err) => {
                    if (err) {
                        addDebugLog('‚ùå Error al publicar: ' + err.message, 'error');
                    } else {
                        addDebugLog('‚úÖ Comando enviado correctamente', 'success');
                    }
                });
                return true;
            } catch (error) {
                addDebugLog('‚ùå Excepci√≥n al publicar: ' + error.message, 'error');
                return false;
            }
        }
        
        async function sendTestMessage() {
            const testPayload = {
                "test": true,
                "timestamp": new Date().toISOString(),
                "message": "Test desde interfaz web"
            };
            
            addDebugLog('üß™ Enviando mensaje de prueba...', 'info');
            const success = await sendMQTTCommand(testPayload);
            
            if (success) {
                showStatus('‚úÖ Mensaje de prueba enviado');
            }
        }
        
        async function resetWLED() {
            addDebugLog('üî¥ Apagando LEDs...', 'info');
            
            const payload = {
                "on": false,
                "seg": [{
                    "fx": 0,
                    "sx": 0,
                    "ix": 0,
                    "pal": 0,
                    "col": [[0,0,0]]
                }]
            };
            
            await sendMQTTCommand(payload);
            showStatus('‚úì LEDs apagados');
        }
        
        async function testColorDirect(color) {
            let rgb;
            switch(color) {
                case 'red':
                    rgb = applyColorOrder(255, 0, 0);
                    break;
                case 'green':
                    rgb = applyColorOrder(0, 255, 0);
                    break;
                case 'blue':
                    rgb = applyColorOrder(0, 0, 255);
                    break;
                default:
                    return;
            }
            
            addDebugLog(`üß™ Test de color: ${color.toUpperCase()}`, 'info');
            
            await sendMQTTCommand({
                "on": true,
                "bri": currentBrightness,
                "seg": [{
                    "fx": 0,
                    "col": [rgb]
                }]
            });
            
            const colorNames = {red: 'ROJO', green: 'VERDE', blue: 'AZUL'};
            showStatus(`‚úì Test ${colorNames[color]} enviado`);
        }
        
        async function testColorRGB() {
            showStatus('üåà Iniciando ciclo RGB...');
            addDebugLog('üåà Ciclo RGB iniciado', 'info');
            
            for (let color of ['red', 'green', 'blue']) {
                await testColorDirect(color);
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            addDebugLog('‚úÖ Ciclo RGB completado', 'success');
            showStatus('‚úì Ciclo RGB completado');
        }
        
        function updateSelectedColor() {
            selectedColor = document.getElementById('ledColor').value;
            addDebugLog(`üé® Color seleccionado: ${selectedColor}`, 'info');
        }
        
        function activatePaintMode() {
            paintMode = !paintMode;
            const btn = document.getElementById('paintBtn');
            
            if (paintMode) {
                btn.classList.add('active');
                btn.textContent = 'Paint Mode: ON';
                showStatus('üé® Paint Mode activado');
                addDebugLog('üé® Paint Mode activado', 'info');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Activar Paint Mode';
                showStatus('Paint Mode desactivado');
                addDebugLog('Paint Mode desactivado', 'info');
            }
        }
        
        async function updateBrightness() {
            currentBrightness = parseInt(document.getElementById('brightness').value);
            const percent = Math.round((currentBrightness / 255) * 100);
            document.getElementById('brightVal').textContent = `${percent}%`;
            
            await sendMQTTCommand({
                "bri": currentBrightness
            });
        }
        
        // =====================================================
        // UTILIDADES
        // =====================================================
        
        function applyColorOrder(r, g, b) {
            switch(COLOR_ORDER) {
                case 'RGB':
                    return [r, g, b];
                case 'GRB':
                    return [g, r, b];
                case 'BGR':
                    return [b, g, r];
                case 'RBG':
                    return [r, b, g];
                case 'GBR':
                    return [g, b, r];
                case 'BRG':
                    return [b, r, g];
                default:
                    return [r, g, b];
            }
        }
        
        function generateStars() {
            const starsContainer = document.getElementById('stars');
            for(let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        
        function showStatus(message, isError = false) {
            const oldMessage = document.querySelector('.status-message');
            if (oldMessage) oldMessage.remove();
            
            const status = document.createElement('div');
            status.className = 'status-message';
            status.textContent = message;
            if (isError) {
                status.style.background = '#dc3545';
            }
            document.body.appendChild(status);
            
            setTimeout(() => {
                status.remove();
            }, 3000);
        }
        
        // =====================================================
        // THREE.JS (Simplificado)
        // =====================================================
        
        function initThreeJS() {
            const canvas = document.getElementById('treeCanvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            camera.position.z = 5;
            
            ledGroup = new THREE.Group();
            scene.add(ledGroup);
            
            // Luz ambiental
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            animate();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            if (ledGroup) ledGroup.rotation.y += 0.001;
            renderer.render(scene, camera);
        }
        
        // =====================================================
        // INICIALIZACI√ìN
        // =====================================================
        
        window.onload = function() {
            addDebugLog('üöÄ Aplicaci√≥n iniciada', 'success');
            addDebugLog('üìù Versi√≥n simplificada para Mosquitto', 'info');
            
            initThreeJS();
            generateStars();
            
            // Iniciar conexi√≥n MQTT autom√°ticamente
            setTimeout(() => {
                initMQTT();
            }, 500);
        };
    </script>
</body>
</html>
